<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Message Analyzer</title>

    <!-- Bootstrap core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/stylesheets/jumbotron-narrow.css" rel="stylesheet">
    <link href="/stylesheets/custom.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>


    <script>
        $(function() {
            var nameDateMap;
            var nameCount;

            var name = $("#name");
            var retry = $("#retry");

            retry.hide();
            $("#analysis").hide();

            $.ajax({
                url: "/scripts/analyzer.js",
                dataType: "script",
                success: ""
            });

            retry.on("click", function(e) {
                $("#analysis").hide();
                $("#datepicker").datepicker("destroy");
                name$("#retry").hide();
                $("#browse").show();
            });

            name.on("change", function(e) {
                var nameVal = $("#name").val();
                var datePicker = $("#datepicker");
                var messages = $("#messages");

                datePicker.datepicker("destroy");
                messages.html("");

                datePicker.datepicker({
                    oldDateText: "",
                    beforeShowDay: function(date) {
                        if (nameDateMap[nameVal][date])
                            return [true, 'event', ''];
                        else
                            return [true, '', ''];
                    },
                    onSelect: function(dateText, inst) {
                        var messages = $("#messages");

                        if (this.oldDateText === dateText && messages.is(":visible")) {
                            messages.hide();
                        } else {
                            messages.show();
                        }

                        this.oldDateText = dateText;

                        messages.html("");
                        var messageText = nameDateMap[nameVal][new Date(dateText)];
                        messageText.slice().reverse().forEach(function(message) {
                            $("#messages").append($("<tr><td>" + nameVal + "</td><td>" + message + "</td></tr>"));
                        });
                    }
                });
            });

            $('#fileinput').change(function() {
                $("#browse").hide();
                retry.show();
                retry.text("Loading...");

                var htmlFile = $('#fileinput')[0].files[0];

                var reader = new FileReader();

                reader.onload = function(event) {
                    var data = process(event.target.result);

                    nameDateMap = data.nameDateMap;
                    nameCount = data.nameCount;

                    var names = Object.keys(nameCount).sort(function(a, b) {
                        return nameCount[b] - nameCount[a];
                    });

                    $.each(names, function(a, b) {
                        name.append($("<option/>").attr("value", b).text(b +
                                " (" + nameCount[b] + ")"));
                    });

                    retry.text("Reset!");
                    name.show();
                    $("#analysis").show();
                    name.change();
                }

                reader.readAsText(htmlFile);
            });
        });
    </script>
</head>

<body>

<div class="container">

    <div class="jumbotron">
        <h1>Message Analyzer</h1>
        <br />
        <div class="center">
            <br />
            <p><label id="browse" for="fileinput" class="btn btn-lg btn-success" role="button">Select your 'messages.htm'!</label></p>
            <p><label id="retry" class="btn btn-lg btn-success" role="button"></label></p>

            <input id="fileinput" class="btn btn-lg btn-success" type="file" name="html">
        </div>

        <div id="analysis" class="center row">
            <div class="col-lg-12">
                <div>
                    <select id="name"></select>
                </div>

                <br />

                <div id="datepicker-center">
                    <div id="datepicker"></div>
                </div>

                <table class="table" id="messages"></table>
            </div>
        </div>

    </div>

</div>

</body>
</html>
