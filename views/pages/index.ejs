<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Message Analyzer</title>

    <!-- Bootstrap core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/stylesheets/jumbotron-narrow.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <style>
        .event a {
            background-color: #42B373 !important;
            background-image :none !important;
            color: #ffffff !important;
        }
        .center {
            text-align: center;
        }
        input[type="file"] {
            display: none;
        }
        #datepicker-center {
            display: inline-block;
            margin: 0 auto;
        }
    </style>

    <script>
        $(function() {
            var nameDateMap;
            var nameCount;

            $("#name").hide();
            $("#retry").hide();

            $.ajax({
                url: "/scripts/analyzer.js",
                dataType: "script",
                success: ""
            });

            $('#fileinput').change(function() {
                $("#browse").hide();
                $("#retry").show();
                $("#retry").text("Loading...");

                var htmlFile = $('#fileinput')[0].files[0];

                var reader = new FileReader();

                reader.onload = function(event) {
                    var data = process(event.target.result);

                    nameDateMap = data.nameDateMap;
                    nameCount = data.nameCount;

                    var names = Object.keys(nameCount).sort(function(a, b) {
                        return nameCount[b] - nameCount[a];
                    });

                    $.each(names, function(a, b) {
                        $("#name").append($("<option/>").attr("value", b).text(b +
                                " (" + nameCount[b] + ")"));
                    });

                    $("#name").show();
                    $("#retry").text("Reset!");
                }

                reader.readAsText(htmlFile);
            });

            $("#retry").on("click", function(e) {
                $("#name").hide();
                $("#datepicker").datepicker("destroy");
                $("#retry").hide();
                $("#browse").show();
            });

            $("#name").on("change", function(e) {
                var name = $("#name").val();

                $("#datepicker").datepicker("destroy");
                $("#messages").html("");

                $("#datepicker").datepicker({
                    beforeShowDay: function(date) {
                        if (nameDateMap[name][date])
                            return [true, 'event', ''];
                        else
                            return [true, '', ''];
                    },
                    onSelect: function(dateText, inst) {
                        $("#messages").html("");
                        var messages = nameDateMap[name][new Date(dateText)];
                        messages.slice().reverse().forEach(function(message) {
                            $("#messages").append($("<tr><td>" + name + "</td><td>" + message + "</td></tr>"));
                        });
                    }
                });
            });
        });
    </script>
</head>

<body>

<div class="container">

    <div class="jumbotron">
        <h1>Message Analyzer</h1>
        <br />
        <div class="center">
            <p><label id="browse" for="fileinput" class="btn btn-lg btn-success" role="button">Select your 'messages.htm'!</label></p>
            <p><label id="retry" class="btn btn-lg btn-success" role="button"></label></p>

            <!-- Create a div which will be the canvasloader wrapper -->
            <div id="canvasloader-container" class="wrapper"></div>

            <input id="fileinput" class="btn btn-lg btn-success" type="file" name="html">
        </div>

        <div class="center row">
            <div class="col-lg-12">
                <div>
                    <select id="name"></select>
                </div>

                <br />

                <div id="datepicker-center">
                    <div id="datepicker"></div>
                </div>

                <table class="table" id="messages"></table>
            </div>
        </div>

    </div>

</div>

</body>
</html>
