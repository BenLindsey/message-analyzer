<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Message Analyzer</title>

    <!-- Bootstrap core CSS -->
    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/stylesheets/jumbotron-narrow.css" rel="stylesheet">
    <link href="/stylesheets/custom.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <script src="/scripts/bootstrap.min.js"></script>
    <script src="/scripts/main.js"></script>

    <script>
        $(function() {
            var nameDateMap;
            var threadDateMap;
            var nameCount;

            var name = $("#name");
            var retry = $("#retry");

            retry.hide();
            $("#analysis").hide();

            retry.on("click", function(e) {
                $("#analysis").hide();
                $("#datepicker").datepicker("destroy");
                $("#retry").hide();
                $("#browse").show();
            });

            name.on("change", function(e) {
                var nameVal = $("#name").val();
                var datePicker = $("#datepicker");
                var tables = $("#tables");

                datePicker.datepicker("destroy");
                tables.html("");

                datePicker.datepicker({
                    oldDateText: "",
                    beforeShowDay: function(date) {
                        if (nameDateMap[nameVal][date])
                            return [true, 'event', ''];
                        else
                            return [true, '', ''];
                    },
                    onSelect: function(dateText, inst) {
                        var tables = $("#tables");

                        if (this.oldDateText === dateText && tables.is(":visible")) {
                            tables.hide();
                        } else {
                            tables.show();
                        }

                        this.oldDateText = dateText;

                        tables.html("");

                        var currentDate = new Date(dateText);
                        var threadNames = nameDateMap[nameVal][currentDate];

                        threadNames.filter(function(threadName) {
                            return ~threadName.indexOf(nameVal);
                        });

                        threadNames.forEach(function(threadName) {
                            var messageObjects = threadDateMap[threadName][currentDate];

                            var table = $("<br /><table class=\"table\"><th colspan=\"2\">" + threadName + "</th></table>");

                            messageObjects.slice().forEach(function(messageObject) {
                                table.append($("<tr><td>" + messageObject.name + "</td><td>" + messageObject.message + "</td></tr>"));
                            });

                            tables.append(table);
                        });

                    }
                });


            });

            $('#fileinput').change(function() {
                $("#browse").hide();
                retry.show();
                retry.text("Loading...");

                var htmlFile = $('#fileinput')[0].files[0];

                var reader = new FileReader();

                reader.onload = function(event) {
                    var data = process(event.target.result);

                    nameDateMap = data.nameDateMap;
                    threadDateMap = data.threadDateMap;
                    nameCount = data.nameCount;

                    var names = Object.keys(nameCount).sort(function(a, b) {
                        return nameCount[b] - nameCount[a];
                    });

                    $.each(names, function(a, b) {
                        name.append($("<option/>").attr("value", b).text(b +
                                " (" + nameCount[b] + ")"));
                    });

                    retry.text("Reset!");
                    name.show();
                    $("#analysis").show();
                    name.change();
                }

                reader.readAsText(htmlFile);

                $(this).val("");
            });
        });
    </script>
</head>

<body>

<div class="container">

    <div class="jumbotron">
        <h1>Message Analyzer</h1>
        <br />
        <div class="center">
            <br />
            <p><label id="browse" for="fileinput" class="btn btn-lg btn-success" role="button">Select your 'messages.htm'!</label></p>
            <p><label id="retry" class="btn btn-lg btn-success" role="button"></label></p>

            <input id="fileinput" class="btn btn-lg btn-success" type="file" name="html">
        </div>

        <div id="analysis" class="center row">
            <div class="col-lg-12">
                <div>
                    <select id="name"></select>
                </div>

                <br />

                <ul class="nav nav-tabs centered" role="tablist">
                    <li role="presentation" class="active"><a href="#calendar" aria-controls="calendar" role="tab" data-toggle="tab">Calendar</a></li>
                    <li role="presentation"><a href="#wordcloud" aria-controls="wordcloud" role="tab" data-toggle="tab">Word Cloud</a></li>
                </ul>

                <br />

                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="calendar">
                        <div id="datepicker-center">
                            <div id="datepicker"></div>
                        </div>

                        <div id="tables"></div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="wordcloud">
                        <p>test</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

</body>
</html>
